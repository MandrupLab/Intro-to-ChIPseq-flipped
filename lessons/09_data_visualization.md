---
title: "Visualization of peaks"
author: "Meeta Mistry, Jihe Liu"
date: "Aug 11th, 2021"
---

Approximate time:

## Learning Objectives

* ...

## Qualitative assessment of peak enrichment

The quality of ChIP-seq experiments can be especially difficult to evaluate when little is known about the factor and its binding motif, as is the case with PRDM16. The methods for peak call quality assessment can be seperated into those that are more quantitative (which we will not be covering in this workshop) and those that are qualitative. Qualitative methods typically include a **traditional site-inspection-based evaluation** using a genome viewer or the **exploration of  aggregated read density in selected regions** using profile plots and heatmaps. When applied and interpreted together, these approaches provide a valuable overall assessment of experimental success and data quality. In this lesson, we will cover the latter of the qualitative approaches mentioned above.

> **NOTE:** The ENCODE Consortium has developed and uses various metrics to assess [enrichment](https://www.encodeproject.org/data-standards/terms/#enrichment) and [complexity](https://www.encodeproject.org/data-standards/terms/#library) aspects of ChIP-seq quality, however these quanitative measures are outside of the scope of this workshop an will not be covered.

## Profile plots
We will be generating profile plots to evaluate enrichment in our samples and try and decipher the nature of PRDM16 binding in cortical neurons. The profile plot allows us to **evaluate read density over sets of genomic regions**. Typically, these regions are genes, but any other regions defined in BED will work. 

We will be using the `plotProfile` command that is part of the [deepTools suite](https://deeptools.readthedocs.io/en/develop/content/tools/plotProfile.html), to create our profile plots. To use this, a matrix generated by `computeMatrix` is required. You will need to **create a matrix for every new plot you generate**, so this step of the workflow can often take some time. In this lesson, we teach you how to create a matrix for the first figure we generate and then provide the pre-computed matrices for you to use to save time.

<p align="center">
<img src="../img/computeMatrix_overview.png" width="700">
</p>

_Image source: [deepTools documentation](https://deeptools.readthedocs.io/en/develop/content/tools/computeMatrix.html?highlight=computeMatrix)_

> *NOTE:* The matrix we generate can also be used as input to [`plotHeatmap`](https://deeptools.readthedocs.io/en/develop/content/tools/plotHeatmap.html?highlight=plotheatmap). Heatmaps are also a very popular data visualization option for peak call data. We will not be plotting heatmaps in this lesson, but encourage you to explore the command and the numerous parameters available for optimization.

### Setting up 

> _NOTE:_ If you have just completed the last lesson on creating bigWig files, you may already have yourself setup!

To get started you will need to be on a **compute node** and ensure you have an interactive session with **6 cores and 10G of memory**. The `computeMatrix` command can take some time, so we want to take advantage of the multi-threading. 

```bash
srun --pty -p interactive -t 0-5:00 -c 6 --mem 8G /bin/bash
```

Once you are on a compute node, load the modules:

```bash
$ module load python/2.7.12 deeptools/3.0.2 
```

Finally, we will move into our results directory and copy over the necessary bigWig files:

```bash
$ cd ~/chipseq_workshop/results/

$ cp /n/groups/hbctraining/harwell-datasets//workshop_material/results/visualization/bigWig/*chip.bw visualization/bigWig/
```

### Assessing read density between replicates

We have already shown that for our WT samples there are a good number of overlapping regions. Using `bedtools` we were able to extract a bed file of those consensus peaks. The next question is, **what kind of signal is observed for each replicate across these shared regions?**

The first step in creating the profile plot is to create the matrix. The `computeMatrix` command accepts multiple bigWig files and multiple region files (BED format) to create a count matrix. The command can also filter and sort regions according to their scores. For each window, `computeMatrix` will calculate scores based on the read density values in the bigWig files.

Below we describe the **parameters** we will be using:

* `reference-point`: The reference point for plotting. Here, we use the center of the consensus peaks (default is TSS).
* `-b`, `a`: Specify a window around the reference point (before and after). We have used +/- 4000 bp. 
* `-R`: The region file will be the BED file we generated for WT replicate overlap.
* `-S`: The list of bigWig files (WT replicates), that we have generated for you.
* `--skipZeros`: Do not incude regions with only scores of zero
* `-o`: output file name
* `-p`: number of cores


Let's create a matrix for the WT replicates:

```bash
computeMatrix reference-point --referencePoint center \
-b 4000 -a 4000 \
-R ~/chipseq_workshop/results/macs2/wt_peaks_final.bed \
-S visualization/bigWig/wt_sample2_chip.bw visualization/bigWig/wt_sample2_chip.bw \
--skipZeros \
-o ~/chipseq_workshop/results/visualization/wt_matrix.gz \
-p 6
```
> _Runtime estimate: 8-10 minutes_

Once you have computed the matrix, you can create the **profile plot**. First, make a directory designated for the figures we will be creating, and then we will run `plotProfile`. _The `plotProfile` command will take a shorter amount of time to run._ 

> **NOTE:** `plotProfile` has many options to optimize your figure, including the ability to change the type of lines plotted, and to plot by group rather than sample. We encourage you to explore the [documentation](https://deeptools.readthedocs.io/en/develop/content/tools/plotProfile.html?highlight=plotProfile) to find out more detail.

```bash

# Create figures directory under visualization
mkdir ~/chipseq_workshop/results/visualization/figures

# Plot the profiles
plotProfile -m ~/chipseq_workshop/results/visualization/wt_matrix.gz \
-out ~/chipseq_workshop/results/visualization/figures/plot1_wt_replciates.png \
--regionsLabel "" \
--perGroup \
--colors red blue \
--samplesLabel "WT_replicate1" "WT_replicate2" \
--refPointLabel "PRDM16 binding sites"

```

> **NOTE:** The output of `plotProfile` will be a PNG image file, which you **will not be able to open on the cluster**. To view the file you will want to use [FileZilla](03_QC_FASTQC.md#what-is-filezilla) to move it over to your local computer. 

The figure should like the one displayed below. We observe that the **replicate 2 has a much higher signal** present in these regions. This is not uncommon in ChIP-seq data. What is encouraging to see is that there is a **decent amount of signal in both replicates**, so we have some confidence in the regions we identified.


<p align="center">
<img src="../img/09_plot1_wt.png" width="500">
</p>


***

**Exercise: Assessing loss of signal in the KO samples**

The KO samples in the dataset represent two separate pools of E15.5 Prdm16 conditional knockout cortices. It would be good to **evaluate PRDM binding sites** in samples where the PRDM16 is rendered non-functional, and **see how read density compares to the WT**.

1. Modify the `computeMatrix` command we previously used so the input bigWigs are now KO the KO replicates. You will also want to change the name of the ouput file to `ko_matrix.gz`.
2. Compute the matrix.
3. Draw the profile plot. Be sure to modify the `--samplesLabel` to KO.
4. Comment on the plot.

<details>
  <summary>Code</summary>
  
 <p><pre>
 
  computeMatrix reference-point --referencePoint center \
    -b 4000 -a 4000 \
    -R ~/chipseq_workshop/results/macs2/wt_peaks_final.bed \
    -S visualization/bigWig/ko_sample1_chip.bw visualization/bigWig/ko_sample2_chip.bw \
    --skipZeros \
    -o ~/chipseq_workshop/results/visualization/ko_matrix.gz \
    -p 6

    plotProfile -m ~/chipseq_workshop/results/visualization/ko_matrix.gz \
    -out ~/chipseq_workshop/results/visualization/figures/plot2_ko_replciates.png \
    --regionsLabel "" \
    --perGroup \
    --colors red blue \
    --samplesLabel "KO_replicate1" "KO_replicate2" \
    --refPointLabel "PRDM16 binding sites"
    
  </pre></p>
 </details>

***

We explored profiles at the center of region. How about the TSS region? Compute the matrix with TSS as the reference point, and then plot the corresponding profile. What does the profile look like? Could you think of why it looks like that?

## Plotting with histone methylation pattern
After plotting the binding pattern for PRDM16, we then ask: how does PRDM16 regulates the gene expression? Let's explore one of the possibilities here: histone methylation. Histone methylation could up-regulate or down-regulate the gene expression, depending on the position of methylation. We could analyze the overlap of PRDM16-binding regions with different histone methylation marks (H3K4me, H3K4me3, H3K27me3), and speculate the mechanism of regulation accordingly. The data for the histone methylation level could be obtained from the Encyclopedia of DNA Elements ([ENCODE](https://www.encodeproject.org/)), which we have put in our training directory (`/n/groups/hbctraining/harwell-datasets/encode-chipseq/`). To fasten the computing process, we could submit a running job, instead of running on an interactive node. Create a sbatch script as below (with the name `plot2.sbatch`, and then run the script using `sbatch plot2.sbatch` command.

```bash
#!/bin/sh

#SBATCH -p priority
#SBATCH -c 2
#SBATCH -t 0-1:00
#SBATCH --mem 16G

computeMatrix reference-point --referencePoint center \
-b 4000 -a 4000 \
-R ~/chipseq_workshop/results/macs2/wt_peaks_final.bed \
-S ~/chipseq_workshop/results/visualization/bigWig/wt_sample2_chip.bw /n/groups/hbctraining/harwell-datasets/encode-chipseq/H3k04me1UE14_mm10.bw /n/groups/hbctraining/harwell-datasets/encode-chipseq/H3k04me3UE14_mm10.bw /n/groups/hbctraining/harwell-datasets/encode-chipseq/H3k27me3UE14_mm10.bw \
--skipZeros \
-o ~/chipseq_workshop/results/visualization/wt_encode_matrix.gz \
-p 6

plotProfile -m ~/chipseq_workshop/results/visualization/wt_encode_matrix.gz \
-out ~/chipseq_workshop/results/visualization/figures/plot2_wt_encode.png \
--regionsLabel "" \
--perGroup \
--colors blue green red orange \
--samplesLabel "PRDM16" "H3K4me" "H3K4me3" "H3K27me3" \
--refPointLabel "PRDM16 binding sites"
```

We observed some moderate levels of H3K4me3 and H3K4me in PRDM16-binding regions. The result makes sense, because both H3K4me3 and H3K4me are associated with transcriptional activation. Not surprisingly, H3K27me3 shares little overlap in PRDM16-binding regions, as H3K27me3 is a epigenetic modification associated with transcriptional repression during neurogenesis, and we do not expect transcriptional repression.

<p align="center">
<img src="../img/09_plot2_wt_encode.png" width="500">
</p>

**Exercise**

The study also included PRDM16-knockout experiment (we refer to as `ko`). How does the `ko` sample looks like compared to the `wt` sample? We placed the bigWig file for one of the `ko`sample at the location `/n/groups/hbctraining/harwell-datasets/workshop_material/results/visualization/bigWig/ko_sample2_chip.bw`. Use this, and the bigWig file you generated earlier for `wt`, to plot the peaks. Do you see a difference between `wt` and `ko` samples? Does that match your expectation?

<details>
  <summary>Solution</summary>
  
  ```
  # Navigate to results directory
  computeMatrix reference-point --referencePoint center \
  -b 4000 -a 4000 \
  -R ~/chipseq_workshop/results/macs2/wt_peaks_final.bed \
  -S ~/chipseq_workshop/results/visualization/bigWig/wt_sample2_chip.bw /n/groups/hbctraining/harwell-datasets/workshop_material/results/visualization/bigWig/ko_sample2_chip.bw \
  --skipZeros \
  -o ~/chipseq_workshop/results/visualization/wt_ko_matrix.gz \
  -p 6

  plotProfile -m ~/chipseq_workshop/results/visualization/wt_ko_matrix.gz \
  -out ~/chipseq_workshop/results/visualization/figures/plot4_wt_ko.png \
  --regionsLabel "" \
  --perGroup \
  --colors blue red \
  --samplesLabel "PRDM16_WT" "PRDM16_KO" \
  --refPointLabel "PRDM16 binding sites"
  ```
  
  We observed that the `wt` sample shows significant higher enrichment at PRDM16-binding regions, compared to the `ko` sample. The result matches our expectation, because PRDM16 is knocked out in `ko` sample.
  
  <p align="center">
  <img src="../img/09_plot4_wt_ko.png" width="500">
  </p>

</details>


***
*This lesson has been developed by members of the teaching team at the [Harvard Chan Bioinformatics Core (HBC)](http://bioinformatics.sph.harvard.edu/). These are open access materials distributed under the terms of the [Creative Commons Attribution license](https://creativecommons.org/licenses/by/4.0/) (CC BY 4.0), which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.*
